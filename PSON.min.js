/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(e){function l(e){if(!e)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var c={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};c.Encoder=function(g,b){var c=new g(4);c.length=4;var a=function(d,b){this.dict={};this.next=0;if(d&&Array.isArray(d))for(;this.next<d.length;)this.dict[d[this.next]]=this.next++;
this.progressive=!!b};a.prototype.encode=function(d,b){b||(b=new g);var a=b.littleEndian;try{return this._encodeValue(d,b.LE()),b.littleEndian=a,b}catch(c){throw b.littleEndian=a,c;}};a.prototype._encodeValue=function(d,a){if(null===d)a.writeUint8(b.NULL);else switch(typeof d){case "function":d=d.toString();case "string":0==d.length?a.writeUint8(b.ESTRING):this.dict.hasOwnProperty(d)?(a.writeUint8(b.STRING_GET),a.writeVarint32(this.dict[d])):(a.writeUint8(b.STRING),a.writeVString(d));break;case "number":var f=
parseInt(d);d===f?(f=g.zigZagEncode32(d),f<=b.MAX?a.writeUint8(f):(a.writeUint8(b.INTEGER),a.writeZigZagVarint32(d))):(c.writeFloat32(d,0),d===c.readFloat32(0)?(a.writeUint8(b.FLOAT),a.writeFloat32(d)):(a.writeUint8(b.DOUBLE),a.writeFloat64(d)));break;case "boolean":a.writeUint8(d?b.TRUE:b.FALSE);break;case "object":if(Array.isArray(d))if(0==d.length)a.writeUint8(b.EARRAY);else{a.writeUint8(b.ARRAY);a.writeVarint32(d.length);for(f=0;f<d.length;f++)this._encodeValue(d[f],a)}else try{d=g.wrap(d),a.writeUint8(b.BINARY),
a.writeVarint32(d.length),a.append(d)}catch(e){var k=Object.keys(d);if(0==k.length)a.writeUint8(b.EOBJECT);else{a.writeUint8(b.OBJECT);a.writeVarint32(k.length);for(f=0;f<k.length;f++){var h=k[f];this.dict.hasOwnProperty(h)?(a.writeUint8(b.STRING_GET),a.writeVarint32(this.dict[h])):(this.progressive?(this.dict[h]=this.next++,a.writeUint8(b.STRING_ADD)):a.writeUint8(b.STRING),a.writeVString(h));this._encodeValue(d[h],a)}}}break;case "undefined":a.writeUint8(b.UNDEFINED)}};return a}(e,c.T);c.Decoder=
function(g,b){var c=function(a,d){this.dict=a&&Array.isArray(a)?a:[];this.progressive=!!d};c.prototype.decode=function(a){a instanceof g||(a=g.wrap(a));var d=a.littleEndian;try{var b=this._decodeValue(a.LE());a.littleEndian=d;return b}catch(c){throw a.littleEndian=d,c;}};c.prototype._decodeValue=function(a){var d=a.readUint8();if(d<=b.MAX)return g.zigZagDecode32(d);switch(d){case b.NULL:return null;case b.TRUE:return!0;case b.FALSE:return!1;case b.EOBJECT:return{};case b.EARRAY:return[];case b.ESTRING:return"";
case b.OBJECT:for(var d=a.readVarint32(),c={};0<=--d;)c[this._decodeValue(a)]=this._decodeValue(a);return c;case b.ARRAY:d=a.readVarint32();for(c=[];0<=--d;)c.push(this._decodeValue(a));return c;case b.INTEGER:return a.readZigZagVarint32();case b.LONG:return a.readZigZagVarint64();case b.FLOAT:return a.readFloat32();case b.DOUBLE:return a.readFloat64();case b.STRING:return a.readVString();case b.STRING_ADD:return a=a.readVString(),this.dict.push(a),a;case b.STRING_GET:return this.dict[a.readVarint32()];
case b.BINARY:return d=a.readVarint32(),a.slice(a.offset,a.offset+d);default:throw Error("Illegal type at "+a.offset+": "+d);}};return c}(e,c.T);c.Pair=function(){var c=function(){};c.prototype.encode=function(b){return this.encoder.encode(b)};c.prototype.toArrayBuffer=function(b){return this.encoder.encode(b).toArrayBuffer()};c.prototype.toBuffer=function(b){return this.encoder.encode(b).toBuffer()};c.prototype.decode=function(b){return this.decoder.decode(b)};return c}();c.StaticPair=function(c,
b,e){var a=function(a){c.call(this);this.encoder=new b(a,!1);this.decoder=new e(a,!1)};a.prototype=Object.create(c.prototype);return a}(c.Pair,c.Encoder,c.Decoder);c.ProgressivePair=function(g,b,e){var a=function(a){g.call(this);this.encoder=new b(a,!0);this.decoder=new e(a,!0)};a.prototype=Object.create(g.prototype);a.prototype.exclude=function(a){c.exclude(a)};a.prototype.include=function(a){c.include(a)};return a}(c.Pair,c.Encoder,c.Decoder);c.exclude=function(c){"object"===typeof c&&Object.defineProperty(c,
"_PSON_FROZEN_",{value:!0,enumerable:!1,configurable:!0})};c.include=function(c){"object"===typeof c&&delete c._PSON_FROZEN_};return c}"undefined"!=typeof module&&module.exports?module.exports=l(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("PSON",["ByteBuffer"],l):(e.dcodeIO||(e.dcodeIO={}),e.dcodeIO.PSON=l(e.dcodeIO.ByteBuffer))})(this);
