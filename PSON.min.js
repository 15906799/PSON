/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(h){function l(h){if(!h)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var f={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};f.Encoder=function(g,a){var f=new g(4);f.length=4;var e=g.Long,d=function(a,b){this.dict={};this.next=0;if(a&&Array.isArray(a))for(;this.next<a.length;)this.dict[a[this.next]]=
this.next++;this.progressive=!!b};d.prototype.encode=function(a,b){b||(b=new g);var e=b.littleEndian;try{return this._encodeValue(a,b.LE()),b.littleEndian=e,b}catch(d){throw b.littleEndian=e,d;}};d.prototype._encodeValue=function(c,b,d){if(null===c)b.writeUint8(a.NULL);else switch(typeof c){case "function":c=c.toString();case "string":0==c.length?b.writeUint8(a.ESTRING):this.dict.hasOwnProperty(c)?(b.writeUint8(a.STRING_GET),b.writeVarint32(this.dict[c])):(b.writeUint8(a.STRING),b.writeVString(c));
break;case "number":d=parseInt(c);c===d?(d=g.zigZagEncode32(c),d<=a.MAX?b.writeUint8(d):(b.writeUint8(a.INTEGER),b.writeZigZagVarint32(c))):(f.writeFloat32(c,0),c===f.readFloat32(0)?(b.writeUint8(a.FLOAT),b.writeFloat32(c)):(b.writeUint8(a.DOUBLE),b.writeFloat64(c)));break;case "boolean":b.writeUint8(c?a.TRUE:a.FALSE);break;case "object":if(Array.isArray(c))if(0==c.length)b.writeUint8(a.EARRAY);else{b.writeUint8(a.ARRAY);b.writeVarint32(c.length);for(var h=0;h<c.length;h++)this._encodeValue(c[h],
b)}else if(e&&c instanceof e)b.writeUint8(a.LONG),b.writeZigZagVarint64(c);else try{c=g.wrap(c),b.writeUint8(a.BINARY),b.writeVarint32(c.length),b.append(c)}catch(l){var m=Object.keys(c);if(0==m.length)b.writeUint8(a.EOBJECT);else{b.writeUint8(a.OBJECT);b.writeVarint32(m.length);d||(d=!!c._PSON_EXCL_);for(h=0;h<m.length;h++){var k=m[h];this.dict.hasOwnProperty(k)?(b.writeUint8(a.STRING_GET),b.writeVarint32(this.dict[k])):(this.progressive&&!d?(this.dict[k]=this.next++,b.writeUint8(a.STRING_ADD)):
b.writeUint8(a.STRING),b.writeVString(k));this._encodeValue(c[k],b)}}}break;case "undefined":b.writeUint8(a.UNDEFINED)}};return d}(h,f.T);f.Decoder=function(g,a){var f=function(a,d){this.dict=a&&Array.isArray(a)?a:[];this.progressive=!!d};f.prototype.decode=function(a){a instanceof g||(a=g.wrap(a));var d=a.littleEndian;try{var c=this._decodeValue(a.LE());a.littleEndian=d;return c}catch(b){throw a.littleEndian=d,b;}};f.prototype._decodeValue=function(e){var d=e.readUint8();if(d<=a.MAX)return g.zigZagDecode32(d);
switch(d){case a.NULL:return null;case a.TRUE:return!0;case a.FALSE:return!1;case a.EOBJECT:return{};case a.EARRAY:return[];case a.ESTRING:return"";case a.OBJECT:for(var d=e.readVarint32(),c={};0<=--d;)c[this._decodeValue(e)]=this._decodeValue(e);return c;case a.ARRAY:d=e.readVarint32();for(c=[];0<=--d;)c.push(this._decodeValue(e));return c;case a.INTEGER:return e.readZigZagVarint32();case a.LONG:return e.readZigZagVarint64();case a.FLOAT:return e.readFloat32();case a.DOUBLE:return e.readFloat64();
case a.STRING:return e.readVString();case a.STRING_ADD:return e=e.readVString(),this.dict.push(e),e;case a.STRING_GET:return this.dict[e.readVarint32()];case a.BINARY:return d=e.readVarint32(),e.slice(e.offset,e.offset+d);default:throw Error("Illegal type at "+e.offset+": "+d);}};return f}(h,f.T);f.Pair=function(){var g=function(){};g.prototype.encode=function(a){return this.encoder.encode(a)};g.prototype.toArrayBuffer=function(a){return this.encoder.encode(a).toArrayBuffer()};g.prototype.toBuffer=
function(a){return this.encoder.encode(a).toBuffer()};g.prototype.decode=function(a){return this.decoder.decode(a)};return g}();f.StaticPair=function(g,a,f){var e=function(d){g.call(this);this.encoder=new a(d,!1);this.decoder=new f(d,!1)};e.prototype=Object.create(g.prototype);return e}(f.Pair,f.Encoder,f.Decoder);f.ProgressivePair=function(g,a,h){var e=function(d){g.call(this);this.encoder=new a(d,!0);this.decoder=new h(d,!0)};e.prototype=Object.create(g.prototype);e.prototype.exclude=function(a){f.exclude(a)};
e.prototype.include=function(a){f.include(a)};return e}(f.Pair,f.Encoder,f.Decoder);f.exclude=function(f){"object"===typeof f&&Object.defineProperty(f,"_PSON_EXCL_",{value:!0,enumerable:!1,configurable:!0})};f.include=function(f){"object"===typeof f&&delete f._PSON_EXCL_};return f}"undefined"!=typeof module&&module.exports?module.exports=l(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("PSON",["ByteBuffer"],l):(h.dcodeIO||(h.dcodeIO={}),h.dcodeIO.PSON=l(h.dcodeIO.ByteBuffer))})(this);
