/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(h){function m(h){if(!h)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var f={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};f.Encoder=function(g,a){var f=new g(4);f.length=4;var e=g.Long,c=function(a,b){this.dict={};this.next=0;if(a&&Array.isArray(a))for(;this.next<a.length;)this.dict[a[this.next]]=
this.next++;this.progressive=!!b};c.prototype.encode=function(a,b){b||(b=new g);var e=b.littleEndian;try{return this._encodeValue(a,b.LE()),b.littleEndian=e,b}catch(c){throw b.littleEndian=e,c;}};c.prototype._encodeValue=function(d,b){if(null===d)b.writeUint8(a.NULL);else switch(typeof d){case "function":d=d.toString();case "string":0==d.length?b.writeUint8(a.ESTRING):this.dict.hasOwnProperty(d)?(b.writeUint8(a.STRING_GET),b.writeVarint32(this.dict[d])):(b.writeUint8(a.STRING),b.writeVString(d));
break;case "number":var c=parseInt(d);d===c?(c=g.zigZagEncode32(d),c<=a.MAX?b.writeUint8(c):(b.writeUint8(a.INTEGER),b.writeZigZagVarint32(d))):(f.writeFloat32(d,0),d===f.readFloat32(0)?(b.writeUint8(a.FLOAT),b.writeFloat32(d)):(b.writeUint8(a.DOUBLE),b.writeFloat64(d)));break;case "boolean":b.writeUint8(d?a.TRUE:a.FALSE);break;case "object":if(Array.isArray(d))if(0==d.length)b.writeUint8(a.EARRAY);else{b.writeUint8(a.ARRAY);b.writeVarint32(d.length);for(c=0;c<d.length;c++)this._encodeValue(d[c],
b)}else if(e&&d instanceof e)b.writeUint8(a.LONG),b.writeZigZagVarint64(d);else try{d=g.wrap(d),b.writeUint8(a.BINARY),b.writeVarint32(d.length),b.append(d)}catch(h){var l=Object.keys(d);if(0==l.length)b.writeUint8(a.EOBJECT);else{b.writeUint8(a.OBJECT);b.writeVarint32(l.length);for(c=0;c<l.length;c++){var k=l[c];this.dict.hasOwnProperty(k)?(b.writeUint8(a.STRING_GET),b.writeVarint32(this.dict[k])):(this.progressive?(this.dict[k]=this.next++,b.writeUint8(a.STRING_ADD)):b.writeUint8(a.STRING),b.writeVString(k));
this._encodeValue(d[k],b)}}}break;case "undefined":b.writeUint8(a.UNDEFINED)}};return c}(h,f.T);f.Decoder=function(g,a){var f=function(a,c){this.dict=a&&Array.isArray(a)?a:[];this.progressive=!!c};f.prototype.decode=function(a){a instanceof g||(a=g.wrap(a));var c=a.littleEndian;try{var d=this._decodeValue(a.LE());a.littleEndian=c;return d}catch(b){throw a.littleEndian=c,b;}};f.prototype._decodeValue=function(e){var c=e.readUint8();if(c<=a.MAX)return g.zigZagDecode32(c);switch(c){case a.NULL:return null;
case a.TRUE:return!0;case a.FALSE:return!1;case a.EOBJECT:return{};case a.EARRAY:return[];case a.ESTRING:return"";case a.OBJECT:for(var c=e.readVarint32(),d={};0<=--c;)d[this._decodeValue(e)]=this._decodeValue(e);return d;case a.ARRAY:c=e.readVarint32();for(d=[];0<=--c;)d.push(this._decodeValue(e));return d;case a.INTEGER:return e.readZigZagVarint32();case a.LONG:return e.readZigZagVarint64();case a.FLOAT:return e.readFloat32();case a.DOUBLE:return e.readFloat64();case a.STRING:return e.readVString();
case a.STRING_ADD:return e=e.readVString(),this.dict.push(e),e;case a.STRING_GET:return this.dict[e.readVarint32()];case a.BINARY:return c=e.readVarint32(),e.slice(e.offset,e.offset+c);default:throw Error("Illegal type at "+e.offset+": "+c);}};return f}(h,f.T);f.Pair=function(){var g=function(){};g.prototype.encode=function(a){return this.encoder.encode(a)};g.prototype.toArrayBuffer=function(a){return this.encoder.encode(a).toArrayBuffer()};g.prototype.toBuffer=function(a){return this.encoder.encode(a).toBuffer()};
g.prototype.decode=function(a){return this.decoder.decode(a)};return g}();f.StaticPair=function(g,a,f){var e=function(c){g.call(this);this.encoder=new a(c,!1);this.decoder=new f(c,!1)};e.prototype=Object.create(g.prototype);return e}(f.Pair,f.Encoder,f.Decoder);f.ProgressivePair=function(g,a,h){var e=function(c){g.call(this);this.encoder=new a(c,!0);this.decoder=new h(c,!0)};e.prototype=Object.create(g.prototype);e.prototype.exclude=function(a){f.exclude(a)};e.prototype.include=function(a){f.include(a)};
return e}(f.Pair,f.Encoder,f.Decoder);f.exclude=function(f){"object"===typeof f&&Object.defineProperty(f,"_PSON_FROZEN_",{value:!0,enumerable:!1,configurable:!0})};f.include=function(f){"object"===typeof f&&delete f._PSON_FROZEN_};return f}"undefined"!=typeof module&&module.exports?module.exports=m(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("PSON",["ByteBuffer"],m):(h.dcodeIO||(h.dcodeIO={}),h.dcodeIO.PSON=m(h.dcodeIO.ByteBuffer))})(this);
