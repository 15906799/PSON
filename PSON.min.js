/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(f){function l(f){if(!f)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var e={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};e.Encoder=function(g,b){var e=new g(4);e.length=4;var h=g.Long,a=function(c,d){this.dict={};this.next=0;if(c&&Array.isArray(c))for(;this.next<c.length;)this.dict[c[this.next]]=
this.next++;this.progressive=!!d};a.prototype.encode=function(c,d){d||(d=new g);var b=d.littleEndian;try{return this._encodeValue(c,d.LE()),d.littleEndian=b,d}catch(a){throw d.littleEndian=b,a;}};a.prototype._encodeValue=function(c,d,a){if(null===c)d.writeUint8(b.NULL);else switch(typeof c){case "function":c=c.toString();case "string":0==c.length?d.writeUint8(b.ESTRING):this.dict.hasOwnProperty(c)?(d.writeUint8(b.STRING_GET),d.writeVarint32(this.dict[c])):(d.writeUint8(b.STRING),d.writeVString(c));
break;case "number":a=parseInt(c);c===a?(a=g.zigZagEncode32(c),a<=b.MAX?d.writeUint8(a):(d.writeUint8(b.INTEGER),d.writeZigZagVarint32(c))):(e.writeFloat32(c,0),c===e.readFloat32(0)?(d.writeUint8(b.FLOAT),d.writeFloat32(c)):(d.writeUint8(b.DOUBLE),d.writeFloat64(c)));break;case "boolean":d.writeUint8(c?b.TRUE:b.FALSE);break;case "object":if(Array.isArray(c))if(0==c.length)d.writeUint8(b.EARRAY);else{d.writeUint8(b.ARRAY);d.writeVarint32(c.length);for(var f=0;f<c.length;f++)this._encodeValue(c[f],
d)}else if(h&&c instanceof h)d.writeUint8(b.LONG),d.writeZigZagVarint64(c);else try{c=g.wrap(c),d.writeUint8(b.BINARY),d.writeVarint32(c.remaining()),d.append(c)}catch(l){var m=Object.keys(c);if(0==m.length)d.writeUint8(b.EOBJECT);else for(d.writeUint8(b.OBJECT),d.writeVarint32(m.length),a||(a=!!c._PSON_EXCL_),f=0;f<m.length;f++){var k=m[f];this.dict.hasOwnProperty(k)?(d.writeUint8(b.STRING_GET),d.writeVarint32(this.dict[k])):(this.progressive&&!a?(this.dict[k]=this.next++,d.writeUint8(b.STRING_ADD)):
d.writeUint8(b.STRING),d.writeVString(k));this._encodeValue(c[k],d)}}break;case "undefined":d.writeUint8(b.UNDEFINED)}};return a}(f,e.T);e.Decoder=function(g,b){var e=g.Long,f=function(a,c){this.dict=a&&Array.isArray(a)?a:[];this.progressive=!!c};f.prototype.decode=function(a){a instanceof g||(a=g.wrap(a));var c=a.littleEndian;try{var b=this._decodeValue(a.LE());a.littleEndian=c;return b}catch(e){throw a.littleEndian=c,e;}};f.prototype._decodeValue=function(a){var c=a.readUint8();if(c<=b.MAX)return g.zigZagDecode32(c);
switch(c){case b.NULL:return null;case b.TRUE:return!0;case b.FALSE:return!1;case b.EOBJECT:return{};case b.EARRAY:return[];case b.ESTRING:return"";case b.OBJECT:for(var c=a.readVarint32(),d={};0<=--c;)d[this._decodeValue(a)]=this._decodeValue(a);return d;case b.ARRAY:c=a.readVarint32();for(d=[];0<=--c;)d.push(this._decodeValue(a));return d;case b.INTEGER:return a.readZigZagVarint32();case b.LONG:return e?a.readZigZagVarint64():a.readZigZagVarint32();case b.FLOAT:return a.readFloat32();case b.DOUBLE:return a.readFloat64();
case b.STRING:return a.readVString();case b.STRING_ADD:return a=a.readVString(),this.dict.push(a),a;case b.STRING_GET:return this.dict[a.readVarint32()];case b.BINARY:return c=a.readVarint32(),d=a.slice(a.offset,a.offset+c),a.offset+=c,d;default:throw Error("Illegal type at "+a.offset+": "+c);}};return f}(f,e.T);e.Pair=function(){var g=function(){};g.prototype.encode=function(b){return this.encoder.encode(b)};g.prototype.toArrayBuffer=function(b){return this.encoder.encode(b).toArrayBuffer()};g.prototype.toBuffer=
function(b){return this.encoder.encode(b).toBuffer()};g.prototype.decode=function(b){return this.decoder.decode(b)};return g}();e.StaticPair=function(g,b,e){var f=function(a){g.call(this);this.encoder=new b(a,!1);this.decoder=new e(a,!1)};f.prototype=Object.create(g.prototype);return f}(e.Pair,e.Encoder,e.Decoder);e.ProgressivePair=function(g,b,f){var h=function(a){g.call(this);this.encoder=new b(a,!0);this.decoder=new f(a,!0)};h.prototype=Object.create(g.prototype);h.prototype.exclude=function(a){e.exclude(a)};
h.prototype.include=function(a){e.include(a)};return h}(e.Pair,e.Encoder,e.Decoder);e.exclude=function(e){"object"===typeof e&&Object.defineProperty(e,"_PSON_EXCL_",{value:!0,enumerable:!1,configurable:!0})};e.include=function(e){"object"===typeof e&&delete e._PSON_EXCL_};return e}"undefined"!=typeof module&&module.exports?module.exports=l(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("PSON",["ByteBuffer"],l):(f.dcodeIO||(f.dcodeIO={}),f.dcodeIO.PSON=l(f.dcodeIO.ByteBuffer))})(this);
